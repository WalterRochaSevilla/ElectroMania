// ----------------------------------------------------
// GENERATOR & DATASOURCE
// ----------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----------------------------------------------------
// ENUMS
// ----------------------------------------------------

enum CartState {
  ACTIVE
  INACTIVE
  COMPLETED
}

enum ProductState {
  AVAILABLE
  UNAVAILABLE
  OUT_OF_STOCK
}

enum UserRole {
  ADMIN
  USER
}

enum UserState {
  ACTIVE
  INACTIVE
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  CANCELED
}

enum PaymentMethod {
  CASH // QR / efectivo / transferencia (Bolivia)
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELED
}

enum InvoiceStatus {
  ISSUED
  CANCELED
}

// ----------------------------------------------------
// MODELOS
// ----------------------------------------------------

// üë§ USER
model User {
  uuid          String     @id @default(uuid())
  name          String     @db.VarChar(50)
  email         String     @unique @db.VarChar(50)
  password      String     @db.VarChar(60)
  role          UserRole   @default(USER)
  nit_ci        String     @db.VarChar(15)
  social_reason String     @db.VarChar(100)
  state         UserState  @default(ACTIVE)

  carts         Cart[]
  userOrders    UserOrder[]

  @@map("users")
}

// üõí CART (INTENCI√ìN DE COMPRA)
model Cart {
  cart_id     Int       @id @default(autoincrement())
  user_uuid   String
  state       CartState @default(ACTIVE)
  created_at  DateTime  @default(now())

  user        User      @relation(fields: [user_uuid], references: [uuid])
  cartDetails CartDetails[]
  order       Order?

  @@index([user_uuid, state])
  @@map("cart")
}

// üßæ CART DETAILS (SOLO CARRITO)
model CartDetails {
  id          Int      @id @default(autoincrement())
  cart_id     Int
  product_id  Int
  quantity    Int
  unit_price  Decimal  @db.Decimal(10, 2)

  cart        Cart     @relation(fields: [cart_id], references: [cart_id])
  product     Product  @relation(fields: [product_id], references: [product_id])

  @@unique([cart_id, product_id])
  @@map("cart_details")
}

// üì¶ PRODUCT
model Product {
  product_id    Int           @id @default(autoincrement())
  product_name  String        @unique @db.VarChar(50)
  description   String        @db.VarChar(255)
  price         Decimal       @db.Decimal(10, 2)
  stock         Int           @default(0)
  state         ProductState  @default(AVAILABLE)

  productImages     ProductImage[]
  cartDetails       CartDetails[]
  productCategories ProductCategory[]
  orderItems        OrderItem[]

  @@map("products")
}

// üñºÔ∏è PRODUCT IMAGE
model ProductImage {
  product_id Int
  image      String @db.VarChar(255)

  product    Product @relation(fields: [product_id], references: [product_id])

  @@id([product_id, image])
  @@map("product_images")
}

// üè∑Ô∏è CATEGORY
model Category {
  category_id   Int    @id @default(autoincrement())
  category_name String @unique @db.VarChar(50)
  description   String @db.VarChar(100)

  productCategories ProductCategory[]

  @@map("categories")
}

// üîó PRODUCT ‚Üî CATEGORY
model ProductCategory {
  product_id  Int
  category_id Int

  product  Product  @relation(fields: [product_id], references: [product_id])
  category Category @relation(fields: [category_id], references: [category_id])

  @@id([product_id, category_id])
  @@map("product_categories")
}

// üì¶ ORDER (VENTA)
model Order {
  order_id   Int      @id @default(autoincrement())
  cart_id    Int      @unique
  total      Decimal  @db.Decimal(10, 2)
  status     OrderStatus @default(PENDING)
  created_at DateTime @default(now())

  cart       Cart     @relation(fields: [cart_id], references: [cart_id])
  orderItems OrderItem[]
  payment    Payment?
  invoice    Invoice?
  userOrders UserOrder[]

  @@index([status, created_at])
  @@map("orders")
}

// üì¶ ORDER ITEM (SNAPSHOT HIST√ìRICO)
model OrderItem {
  id            Int      @id @default(autoincrement())
  order_id      Int
  product_id    Int
  product_name  String   @db.VarChar(50)
  unit_price    Decimal  @db.Decimal(10, 2)
  quantity      Int
  total         Decimal  @db.Decimal(10, 2)

  order   Order   @relation(fields: [order_id], references: [order_id])
  product Product @relation(fields: [product_id], references: [product_id])

  @@index([order_id])
  @@map("order_items")
}

// üîó USER ‚Üî ORDER
model UserOrder {
  user_uuid String
  order_id  Int

  user  User  @relation(fields: [user_uuid], references: [uuid])
  order Order @relation(fields: [order_id], references: [order_id])

  @@id([user_uuid, order_id])
  @@map("user_orders")
}

// üí≥ PAYMENT
model Payment {
  payment_id Int @id @default(autoincrement())
  order_id   Int @unique
  amount     Decimal @db.Decimal(10, 2)
  method     PaymentMethod
  status     PaymentStatus @default(PENDING)
  created_at DateTime @default(now())

  order Order @relation(fields: [order_id], references: [order_id])

  @@index([status, method])
  @@map("payments")
}

// üßæ INVOICE (FACTURA)
model Invoice {
  invoice_id     Int      @id @default(autoincrement())
  order_id       Int      @unique
  invoice_number String  @unique @db.VarChar(50)

  nit_ci         String  @db.VarChar(15)
  social_reason  String  @db.VarChar(100)
  total          Decimal @db.Decimal(10, 2)

  status         InvoiceStatus @default(ISSUED)
  issued_at      DateTime @default(now())

  order Order @relation(fields: [order_id], references: [order_id])

  @@index([invoice_number])
  @@map("invoices")
}
